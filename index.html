<!DOCTYPE html>
<html lang="es">
    <!-- Configuración PWA -->
<link rel="icon" type="image/png" href="icon.png">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0284c7">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon.png">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Comando Financiero</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- PWA Config -->
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0ea5e9">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: { 50:'#f0f9ff', 100:'#e0f2fe', 500:'#0ea5e9', 600:'#0284c7', 900:'#0c4a6e' }
                    }
                }
            }
        }
    </script>
    <style>
        body { transition: background-color 0.3s, color 0.3s; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .nav-active { color: #0ea5e9; font-weight: bold; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100 font-sans antialiased pb-24 h-screen flex flex-col overflow-hidden">

    <!-- INPUTS OCULTOS -->
    <input type="file" id="restore-input" accept=".json" class="hidden" onchange="restoreData(this)">

    <!-- ENCABEZADO SUPERIOR -->
    <header class="bg-white dark:bg-gray-800 shadow-sm shrink-0 z-20">
        <div class="max-w-5xl mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-lg font-bold text-brand-600 dark:text-brand-500 flex items-center gap-2">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i> <span id="header-title">Resumen</span>
            </h1>
            <div class="flex gap-3">
                <button onclick="openHelpModal()" class="p-1 rounded-full text-brand-500 hover:bg-brand-50 dark:hover:bg-gray-700 transition" title="Ayuda">
                    <i data-lucide="circle-help" class="w-6 h-6"></i>
                </button>
                <button onclick="toggleTheme()" class="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-yellow-500 transition">
                    <i data-lucide="sun" id="theme-icon" class="w-6 h-6"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- CONTENEDOR PRINCIPAL -->
    <main id="main-container" class="flex-1 overflow-y-auto p-4 space-y-6 max-w-5xl mx-auto w-full no-scrollbar relative">
        
        <!-- VISTA 1: DASHBOARD -->
        <div id="view-dashboard" class="space-y-6 fade-in">
            <!-- Controles de Periodo -->
            <div class="bg-white dark:bg-gray-800 p-3 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 flex flex-col sm:flex-row gap-3 items-center justify-between">
                <div class="flex gap-2 w-full sm:w-auto overflow-x-auto no-scrollbar">
                    <button onclick="setDashPreset('current')" class="px-3 py-1.5 text-xs font-medium bg-brand-100 text-brand-700 rounded-lg whitespace-nowrap hover:bg-brand-200 dark:bg-brand-900/30 dark:text-brand-300 transition">Mes Actual</button>
                    <button onclick="setDashPreset('previous')" class="px-3 py-1.5 text-xs font-medium bg-gray-100 text-gray-600 rounded-lg whitespace-nowrap hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 transition">Mes Pasado</button>
                </div>
                <div class="flex gap-2 w-full sm:w-auto items-center bg-gray-50 dark:bg-gray-900 p-1 rounded-lg">
                    <input type="date" id="dash-date-start" onchange="renderDashboard()" class="bg-transparent border-none text-xs w-full outline-none dark:text-white text-center">
                    <span class="text-gray-400 text-xs">al</span>
                    <input type="date" id="dash-date-end" onchange="renderDashboard()" class="bg-transparent border-none text-xs w-full outline-none dark:text-white text-center">
                </div>
            </div>

            <!-- Balance Cards -->
            <section class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="bg-gradient-to-br from-brand-500 to-brand-700 rounded-2xl p-5 text-white shadow-lg">
                    <p class="text-brand-100 text-xs font-medium uppercase tracking-wider">Disponible</p>
                    <h2 class="text-3xl font-bold mt-1" id="balance-amount">$0.00</h2>
                    <div class="flex justify-between mt-4 text-xs opacity-90">
                        <span><i data-lucide="arrow-up" class="inline w-3 h-3"></i> Ing: <span id="dash-income">$0</span></span>
                        <span><i data-lucide="arrow-down" class="inline w-3 h-3"></i> Gas: <span id="dash-expense">$0</span></span>
                    </div>
                </div>
                <!-- Gráfica -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl p-4 shadow border border-gray-100 dark:border-gray-700 h-40 flex items-center justify-center relative">
                     <canvas id="miniChart"></canvas>
                     <div id="miniChart-empty" class="absolute text-xs text-gray-400 hidden">Sin datos en este periodo</div>
                </div>
            </section>

            <!-- Presupuestos -->
            <section class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-gray-700 dark:text-gray-200">Presupuestos (Alertas)</h3>
                    <button onclick="switchTab('config')" class="text-xs text-brand-500 hover:underline">Configurar</button>
                </div>
                <div id="budgets-container" class="space-y-3">
                    <p class="text-xs text-center text-gray-400 py-2">No has definido presupuestos aún.</p>
                </div>
            </section>
        </div>

        <!-- VISTA 2: HISTORIAL -->
        <div id="view-transactions" class="hidden space-y-4 fade-in">
            <!-- Filtros -->
            <div class="flex flex-col gap-2 bg-white dark:bg-gray-800 p-3 rounded-lg shadow-sm border border-gray-100 dark:border-gray-700">
                <div class="flex gap-2 w-full">
                    <div class="flex-1">
                        <label class="text-[10px] text-gray-400 block mb-1">Desde</label>
                        <input type="date" id="filter-date-start" onchange="renderTransactions()" class="w-full bg-gray-50 dark:bg-gray-700 border-none text-xs rounded p-2 outline-none dark:text-white">
                    </div>
                    <div class="flex-1">
                        <label class="text-[10px] text-gray-400 block mb-1">Hasta</label>
                        <input type="date" id="filter-date-end" onchange="renderTransactions()" class="w-full bg-gray-50 dark:bg-gray-700 border-none text-xs rounded p-2 outline-none dark:text-white">
                    </div>
                </div>
                <div class="flex gap-2 w-full items-center">
                    <div class="flex-1">
                        <label class="text-[10px] text-gray-400 block mb-1">Categoría</label>
                        <select id="filter-category" onchange="renderTransactions()" class="w-full bg-gray-50 dark:bg-gray-700 border-none text-xs rounded p-2 outline-none dark:text-white">
                            <option value="all">Todas</option>
                        </select>
                    </div>
                    <div class="mt-4">
                        <button onclick="exportToExcel()" class="bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 px-3 py-2 rounded text-xs whitespace-nowrap flex items-center gap-1 hover:bg-green-200 transition">
                            <i data-lucide="sheet" class="w-3 h-3"></i> CSV
                        </button>
                    </div>
                </div>
            </div>

            <div id="transactions-list" class="space-y-2 pb-20"></div>
        </div>

        <!-- VISTA 3: METAS Y DEUDAS -->
        <div id="view-goals" class="hidden space-y-6 fade-in">
            <!-- Deudas -->
            <section class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-red-100 dark:border-red-900/30">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-red-600 dark:text-red-400 flex items-center gap-2"><i data-lucide="credit-card" class="w-4 h-4"></i> Deudas</h3>
                    <button onclick="openDebtModal()" class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded hover:bg-red-200">+ Nueva</button>
                </div>
                <div id="debts-list" class="space-y-3"></div>
            </section>

            <!-- Metas -->
            <section class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-emerald-100 dark:border-emerald-900/30">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-emerald-600 dark:text-emerald-400 flex items-center gap-2"><i data-lucide="piggy-bank" class="w-4 h-4"></i> Metas</h3>
                    <button onclick="openGoalModal()" class="text-xs bg-emerald-100 text-emerald-600 px-2 py-1 rounded hover:bg-emerald-200">+ Nueva</button>
                </div>
                <div id="goals-list" class="space-y-3"></div>
            </section>
        </div>

        <!-- VISTA 4: CONFIGURACIÓN -->
        <div id="view-config" class="hidden space-y-4 fade-in">
            
            <!-- Crear Categorías -->
            <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm">
                <h3 class="font-bold mb-3 text-sm flex items-center gap-2"><i data-lucide="tag" class="w-4 h-4 text-brand-500"></i> Categorías Personalizadas (Globales)</h3>
                <p class="text-[10px] text-gray-400 mb-2">Úsalas para Gastos o Ingresos.</p>
                <div class="flex gap-2 mb-3">
                    <input type="text" id="new-cat-name" placeholder="Ej. Inversión, Mascotas..." class="flex-1 bg-gray-50 dark:bg-gray-700 p-2 rounded text-sm outline-none border border-gray-200 dark:border-gray-600 dark:text-white">
                    <input type="color" id="new-cat-color" value="#3b82f6" class="h-9 w-9 rounded cursor-pointer border-none bg-transparent">
                    <button onclick="addCategory()" class="bg-brand-600 text-white p-2 rounded hover:bg-brand-700"><i data-lucide="plus" class="w-4 h-4"></i></button>
                </div>
                <div id="config-categories-list" class="flex flex-wrap gap-2"></div>
            </div>

            <!-- Presupuestos -->
            <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm">
                <h3 class="font-bold mb-3 text-sm flex items-center gap-2"><i data-lucide="calculator" class="w-4 h-4 text-brand-500"></i> Definir Presupuestos (Límites)</h3>
                <p class="text-xs text-gray-500 mb-3">Tope mensual de gasto por categoría.</p>
                <div id="budget-config-list" class="space-y-2 max-h-60 overflow-y-auto pr-1"></div>
            </div>

            <!-- Datos -->
            <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm">
                <h3 class="font-bold mb-3 text-sm flex items-center gap-2"><i data-lucide="database" class="w-4 h-4 text-brand-500"></i> Datos y Respaldo</h3>
                <div class="space-y-2">
                    <button onclick="downloadBackup()" class="w-full flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg text-sm transition hover:bg-gray-100">
                        <span><i data-lucide="download" class="inline w-4 h-4 mr-2"></i> Descargar Respaldo</span>
                    </button>
                    <button onclick="document.getElementById('restore-input').click()" class="w-full flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg text-sm transition hover:bg-gray-100">
                        <span><i data-lucide="upload" class="inline w-4 h-4 mr-2"></i> Restaurar Respaldo</span>
                    </button>
                    <button onclick="wipeData()" class="w-full flex items-center justify-between p-3 bg-red-50 dark:bg-red-900/20 text-red-600 rounded-lg text-sm border border-red-100 dark:border-red-900/30 transition hover:bg-red-100">
                        <span><i data-lucide="trash" class="inline w-4 h-4 mr-2"></i> Borrar Todo (Reset)</span>
                    </button>
                </div>
            </div>
        </div>

    </main>

    <!-- NAVBAR -->
    <nav class="fixed bottom-0 w-full bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 pb-safe z-30 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
        <div class="max-w-5xl mx-auto flex justify-around items-center h-16">
            <button onclick="switchTab('dashboard')" class="nav-btn flex flex-col items-center gap-1 text-gray-400 w-full" id="nav-dashboard">
                <i data-lucide="home" class="w-5 h-5"></i><span class="text-[10px]">Inicio</span>
            </button>
            <button onclick="switchTab('transactions')" class="nav-btn flex flex-col items-center gap-1 text-gray-400 w-full" id="nav-transactions">
                <i data-lucide="list" class="w-5 h-5"></i><span class="text-[10px]">Historial</span>
            </button>
            <div class="relative -top-5">
                <button onclick="openTransactionModal()" class="bg-brand-600 hover:bg-brand-700 text-white w-14 h-14 rounded-full shadow-xl flex items-center justify-center transition-transform hover:scale-110 active:scale-95 ring-4 ring-white dark:ring-gray-900">
                    <i data-lucide="plus" class="w-7 h-7"></i>
                </button>
            </div>
            <button onclick="switchTab('goals')" class="nav-btn flex flex-col items-center gap-1 text-gray-400 w-full" id="nav-goals">
                <i data-lucide="target" class="w-5 h-5"></i><span class="text-[10px]">Metas</span>
            </button>
            <button onclick="switchTab('config')" class="nav-btn flex flex-col items-center gap-1 text-gray-400 w-full" id="nav-config">
                <i data-lucide="settings" class="w-5 h-5"></i><span class="text-[10px]">Config</span>
            </button>
        </div>
    </nav>

    <!-- MODALES -->
    
    <!-- Modal Ayuda -->
    <div id="modal-help" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-md p-6 shadow-2xl max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg dark:text-white">Guía Rápida</h3>
                <button onclick="closeModal('modal-help')" class="text-gray-400"><i data-lucide="x"></i></button>
            </div>
            <div class="space-y-4 text-sm text-gray-600 dark:text-gray-300">
                <p><strong>Inicio:</strong> Resumen financiero. Usa los botones "Mes Actual/Pasado" o cambia las fechas para ver tu quincena.</p>
                <p><strong>Categorías Personalizadas:</strong> En "Config", crea categorías como "Inversión". Estas aparecerán tanto para registrar Gastos como Ingresos.</p>
                <p><strong>Filtros:</strong> En "Historial", si no ves un movimiento, verifica las fechas "Desde/Hasta" o usa el filtro de Categoría.</p>
                <p><strong>Presupuestos:</strong> Asigna límites a tus categorías en "Config" para que aparezcan las barras de progreso en el Inicio.</p>
            </div>
            <button onclick="closeModal('modal-help')" class="w-full mt-6 bg-brand-600 text-white py-2 rounded-lg">Entendido</button>
        </div>
    </div>

    <!-- Modal Transacción -->
    <div id="modal-transaction" class="fixed inset-0 bg-black/60 hidden items-end sm:items-center justify-center z-50 p-0 sm:p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white dark:bg-gray-800 rounded-t-2xl sm:rounded-2xl w-full max-w-md shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center">
                <h3 class="font-bold dark:text-white">Nuevo Movimiento</h3>
                <button onclick="closeModal('modal-transaction')" class="p-1 text-gray-400"><i data-lucide="x"></i></button>
            </div>
            <form onsubmit="saveTransaction(event)" class="p-4 space-y-4 overflow-y-auto">
                <input type="hidden" id="tx-id">
                <div class="flex bg-gray-100 dark:bg-gray-700 p-1 rounded-lg">
                    <button type="button" id="btn-type-expense" onclick="setTxType('expense')" class="flex-1 py-2 text-sm font-bold rounded shadow bg-white text-red-500">Gasto</button>
                    <button type="button" id="btn-type-income" onclick="setTxType('income')" class="flex-1 py-2 text-sm text-gray-500">Ingreso</button>
                </div>
                <input type="hidden" id="tx-type" value="expense">
                <input type="number" id="tx-amount" step="any" required placeholder="$0.00" class="w-full text-3xl font-bold text-center bg-transparent border-b border-gray-200 dark:border-gray-700 outline-none p-2 dark:text-white">
                <div class="grid grid-cols-2 gap-3">
                    <input type="date" id="tx-date" required class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg text-sm dark:text-white outline-none">
                    <select id="tx-category" class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg text-sm dark:text-white outline-none"></select>
                </div>
                <input type="text" id="tx-desc" required placeholder="Descripción (ej. Tacos)" class="w-full bg-gray-50 dark:bg-gray-700 p-3 rounded-lg text-sm dark:text-white outline-none">
                <div id="viaticos-check" class="flex items-center gap-2 p-3 bg-orange-50 dark:bg-orange-900/20 rounded-lg text-sm">
                    <input type="checkbox" id="tx-viatico" class="w-4 h-4">
                    <label for="tx-viatico" class="text-orange-700 dark:text-orange-300">Es viático / viaje</label>
                </div>
                <button type="submit" class="w-full bg-brand-600 text-white py-3 rounded-lg font-bold shadow-lg hover:bg-brand-700">Guardar</button>
            </form>
        </div>
    </div>

    <!-- Modal Deuda -->
    <div id="modal-debt" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-sm p-5 shadow-2xl">
            <h3 class="font-bold mb-4 dark:text-white">Registrar Deuda</h3>
            <form onsubmit="saveDebt(event)" class="space-y-3">
                <input type="text" id="debt-name" required placeholder="Nombre" class="w-full p-2 border rounded dark:bg-gray-700 dark:text-white">
                <input type="number" id="debt-total" required placeholder="Monto Total" step="any" class="w-full p-2 border rounded dark:bg-gray-700 dark:text-white">
                <div class="flex gap-2 pt-2">
                    <button type="button" onclick="closeModal('modal-debt')" class="flex-1 bg-gray-200 dark:bg-gray-700 py-2 rounded">Cancelar</button>
                    <button type="submit" class="flex-1 bg-red-500 text-white py-2 rounded">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Meta -->
    <div id="modal-goal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-sm p-5 shadow-2xl">
            <h3 class="font-bold mb-4 dark:text-white">Nueva Meta</h3>
            <form onsubmit="saveGoal(event)" class="space-y-3">
                <input type="text" id="goal-name" required placeholder="Nombre Meta" class="w-full p-2 border rounded dark:bg-gray-700 dark:text-white">
                <input type="number" id="goal-target" required placeholder="Monto Objetivo" step="any" class="w-full p-2 border rounded dark:bg-gray-700 dark:text-white">
                <input type="number" id="goal-current" placeholder="Ahorro Inicial" step="any" class="w-full p-2 border rounded dark:bg-gray-700 dark:text-white">
                <div class="flex gap-2 pt-2">
                    <button type="button" onclick="closeModal('modal-goal')" class="flex-1 bg-gray-200 dark:bg-gray-700 py-2 rounded">Cancelar</button>
                    <button type="submit" class="flex-1 bg-emerald-500 text-white py-2 rounded">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- BASE DE DATOS ---
        const DB = {
            transactions: JSON.parse(localStorage.getItem('myExpenses')) || [], 
            categories: JSON.parse(localStorage.getItem('myCategories')) || {},
            debts: JSON.parse(localStorage.getItem('myDebts')) || [],
            goals: JSON.parse(localStorage.getItem('myGoals')) || [],
            budgets: JSON.parse(localStorage.getItem('myBudgets')) || {}
        };

        const defaultCats = {
            'Alimentos': '#F87171', 'Transporte': '#60A5FA', 'Vivienda': '#34D399',
            'Servicios': '#FBBF24', 'Salud': '#F472B6', 'Entretenimiento': '#A78BFA', 'Otros': '#CBD5E1'
        };
        const incomeCats = {
            'Nómina': '#10B981', 'Ventas': '#34D399', 'Reembolso': '#6EE7B7', 'Inversión (Retorno)': '#059669', 'Otros Ingresos': '#D1FAE5'
        };

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            initTheme();
            initData();
            setDefaultDates();
            populateFilterCategory(); // FIX: Cargar filtros al inicio
            switchTab('dashboard'); 
        });

        function initData() {
            if(Array.isArray(DB.transactions)) DB.transactions = DB.transactions.map(t => ({...t, type: t.type || 'expense'}));
            if(Object.keys(DB.categories).length === 0) { DB.categories = {...defaultCats}; saveDB('categories'); }
        }

        function saveDB(key) {
            if(key === 'all') {
                localStorage.setItem('myExpenses', JSON.stringify(DB.transactions));
                localStorage.setItem('myCategories', JSON.stringify(DB.categories));
                localStorage.setItem('myDebts', JSON.stringify(DB.debts));
                localStorage.setItem('myGoals', JSON.stringify(DB.goals));
                localStorage.setItem('myBudgets', JSON.stringify(DB.budgets));
            } else {
                let map = {'categories':'myCategories','debts':'myDebts','goals':'myGoals','budgets':'myBudgets','transactions':'myExpenses'};
                localStorage.setItem(map[key] || 'myExpenses', JSON.stringify(DB[key]));
            }
        }

        function switchTab(tabId) {
            ['dashboard', 'transactions', 'goals', 'config'].forEach(id => {
                document.getElementById('view-'+id).classList.add('hidden');
                document.getElementById('nav-'+id)?.classList.remove('nav-active', 'text-brand-600');
                document.getElementById('nav-'+id)?.classList.add('text-gray-400');
            });
            document.getElementById('view-'+tabId).classList.remove('hidden');
            document.getElementById('nav-'+tabId)?.classList.add('nav-active', 'text-brand-600');
            document.getElementById('nav-'+tabId)?.classList.remove('text-gray-400');
            
            const titles = { 'dashboard': 'Resumen', 'transactions': 'Historial', 'goals': 'Metas', 'config': 'Configuración' };
            document.getElementById('header-title').innerText = titles[tabId];

            if(tabId === 'dashboard') {
                if(!document.getElementById('dash-date-start').value) setDashPreset('current');
                else renderDashboard();
            }
            if(tabId === 'transactions') renderTransactions();
            if(tabId === 'goals') renderGoalsView();
            if(tabId === 'config') renderConfig();
        }

        // --- DASHBOARD ---
        let miniChart = null;
        function setDashPreset(preset) {
            const today = new Date();
            let start, end;
            if (preset === 'current') {
                start = new Date(today.getFullYear(), today.getMonth(), 1);
                end = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            } else if (preset === 'previous') {
                start = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                end = new Date(today.getFullYear(), today.getMonth(), 0);
            }
            const fmt = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
            document.getElementById('dash-date-start').value = fmt(start);
            document.getElementById('dash-date-end').value = fmt(end);
            renderDashboard();
        }

        function renderDashboard() {
            const startStr = document.getElementById('dash-date-start').value;
            const endStr = document.getElementById('dash-date-end').value;
            if(!startStr || !endStr) return;

            const txs = DB.transactions.filter(t => t.date >= startStr && t.date <= endStr);
            const income = txs.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
            const expense = txs.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);

            document.getElementById('balance-amount').innerText = formatMoney(income - expense);
            document.getElementById('dash-income').innerText = formatMoney(income);
            document.getElementById('dash-expense').innerText = formatMoney(expense);

            updateMiniChart(txs);
            renderBudgets(txs);
        }

        function updateMiniChart(txs) {
            const ctx = document.getElementById('miniChart');
            const expenses = txs.filter(t => t.type === 'expense');
            if(expenses.length === 0) {
                document.getElementById('miniChart-empty').classList.remove('hidden');
                ctx.style.opacity = 0; return;
            }
            document.getElementById('miniChart-empty').classList.add('hidden');
            ctx.style.opacity = 1;

            const dataMap = {};
            expenses.forEach(t => dataMap[t.category] = (dataMap[t.category] || 0) + t.amount);
            
            if(miniChart) miniChart.destroy();
            miniChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(dataMap),
                    datasets: [{
                        data: Object.values(dataMap),
                        backgroundColor: Object.keys(dataMap).map(c => DB.categories[c] || '#ccc'),
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        function renderBudgets(periodTxs) {
            const container = document.getElementById('budgets-container');
            container.innerHTML = '';
            const catsWithBudget = Object.keys(DB.budgets);
            if(catsWithBudget.length === 0) {
                container.innerHTML = `<p class="text-xs text-center text-gray-400 py-2">Ve a Configuración para definir límites.</p>`; return;
            }
            const spentMap = {};
            periodTxs.filter(t => t.type === 'expense').forEach(t => spentMap[t.category] = (spentMap[t.category] || 0) + t.amount);

            catsWithBudget.forEach(cat => {
                const limit = DB.budgets[cat];
                const spent = spentMap[cat] || 0;
                const percent = Math.min((spent / limit) * 100, 100);
                let col = percent > 90 ? 'bg-red-500' : (percent > 70 ? 'bg-yellow-500' : 'bg-emerald-500');
                container.innerHTML += `
                    <div class="text-sm">
                        <div class="flex justify-between mb-1">
                            <span class="font-medium dark:text-gray-200">${cat}</span>
                            <span class="text-xs text-gray-500">${formatMoney(spent)} / ${formatMoney(limit)}</span>
                        </div>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                            <div class="${col} h-2.5 rounded-full" style="width: ${percent}%"></div>
                        </div>
                    </div>`;
            });
        }

        // --- HISTORIAL ---
        function renderTransactions() {
            const start = document.getElementById('filter-date-start').value;
            const end = document.getElementById('filter-date-end').value;
            const catFilter = document.getElementById('filter-category').value;
            const list = document.getElementById('transactions-list');
            list.innerHTML = '';

            const filtered = DB.transactions.filter(t => {
                return (t.date >= start && t.date <= end) && (catFilter === 'all' || t.category === catFilter);
            }).sort((a, b) => new Date(b.date) - new Date(a.date));

            if(filtered.length === 0) { list.innerHTML = `<div class="text-center text-gray-400 py-10">Sin movimientos</div>`; return; }

            filtered.forEach(t => {
                const isExp = t.type === 'expense';
                const color = isExp ? 'text-gray-800 dark:text-gray-100' : 'text-emerald-600 font-bold';
                const sign = isExp ? '-' : '+';
                const catColor = DB.categories[t.category] || incomeCats[t.category] || '#999';
                
                list.innerHTML += `
                    <div class="flex justify-between items-center bg-white dark:bg-gray-800 p-3 rounded-lg shadow-sm border-b border-gray-50 dark:border-gray-700">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-[10px] font-bold shrink-0" style="background-color:${catColor}">
                                ${t.category.substring(0,2).toUpperCase()}
                            </div>
                            <div class="min-w-0">
                                <p class="font-medium truncate text-sm dark:text-gray-200">${t.description}</p>
                                <p class="text-xs text-gray-400">${t.date} • ${t.category}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="${color} text-sm">${sign}${formatMoney(t.amount)}</p>
                            <button onclick="deleteTransaction('${t.id}')" class="text-xs text-red-400 opacity-50 hover:opacity-100">Borrar</button>
                        </div>
                    </div>`;
            });
        }

        function populateFilterCategory() {
            const select = document.getElementById('filter-category');
            const savedVal = select.value;
            select.innerHTML = '<option value="all">Todas</option>';
            // Fusionar todas las categorías posibles
            const allCats = {...DB.categories, ...incomeCats};
            Object.keys(allCats).sort().forEach(cat => {
                select.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
            select.value = savedVal; // Restaurar selección si es posible
        }

        // --- TRANSACCIONES ---
        function openTransactionModal() {
            document.getElementById('modal-transaction').classList.remove('hidden');
            document.getElementById('modal-transaction').classList.add('flex');
            document.getElementById('tx-date').valueAsDate = new Date();
            document.getElementById('tx-amount').value = '';
            document.getElementById('tx-desc').value = '';
            setTxType('expense');
        }

        function setTxType(type) {
            document.getElementById('tx-type').value = type;
            const btnExp = document.getElementById('btn-type-expense');
            const btnInc = document.getElementById('btn-type-income');
            const viatico = document.getElementById('viaticos-check');
            
            // Estilos
            const active = "flex-1 py-2 text-sm font-bold rounded shadow bg-white transition-all";
            const inactive = "flex-1 py-2 text-sm text-gray-500 hover:bg-gray-200 transition-all";
            
            if(type === 'expense') {
                btnExp.className = active + " text-red-500";
                btnInc.className = inactive;
                viatico.classList.remove('hidden');
            } else {
                btnInc.className = active + " text-emerald-500";
                btnExp.className = inactive;
                viatico.classList.add('hidden');
            }
            
            // RELLENAR SELECTOR (Ahora incluye Custom Categories en AMBOS)
            const select = document.getElementById('tx-category');
            select.innerHTML = '';
            
            // Expense: Default + Custom
            // Income: IncomeDefaults + Custom (FIX APPLIED)
            let catsToShow = {};
            if(type === 'expense') catsToShow = DB.categories;
            else catsToShow = {...incomeCats, ...DB.categories}; // Merge para permitir Custom en Ingreso

            Object.keys(catsToShow).sort().forEach(c => {
                const opt = document.createElement('option');
                opt.value = c; opt.innerText = c;
                select.appendChild(opt);
            });
        }

        function saveTransaction(e) {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('tx-amount').value);
            const desc = document.getElementById('tx-desc').value;
            const date = document.getElementById('tx-date').value;
            const category = document.getElementById('tx-category').value;
            const type = document.getElementById('tx-type').value;
            const isViatico = document.getElementById('tx-viatico').checked;

            DB.transactions.push({
                id: Date.now().toString(),
                amount: Math.abs(amount),
                description: desc,
                date: date,
                category: category,
                type: type,
                isViaticos: (type === 'expense' && isViatico)
            });
            saveDB('transactions');

            // Auto-ajustar filtros para mostrar el dato nuevo si es viejo
            const fStart = document.getElementById('filter-date-start');
            const fEnd = document.getElementById('filter-date-end');
            if(date < fStart.value) fStart.value = date;
            if(date > fEnd.value) fEnd.value = date;

            closeModal('modal-transaction');
            
            const currentTab = document.querySelector('.nav-active').id.replace('nav-', '');
            if(currentTab === 'dashboard') renderDashboard();
            if(currentTab === 'transactions') renderTransactions();
        }

        function deleteTransaction(id) {
            if(confirm('¿Eliminar registro?')) {
                DB.transactions = DB.transactions.filter(t => t.id !== id);
                saveDB('transactions');
                renderTransactions();
                renderDashboard(); // Actualizar dashboard también
            }
        }

        // --- CONFIG ---
        function renderConfig() {
            // Categorías
            const list = document.getElementById('config-categories-list');
            list.innerHTML = '';
            Object.keys(DB.categories).forEach(cat => {
                list.innerHTML += `
                    <div class="flex items-center gap-1 bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded text-xs border border-gray-200 dark:border-gray-600">
                        <div class="w-3 h-3 rounded-full" style="background-color:${DB.categories[cat]}"></div>
                        <span class="dark:text-white">${cat}</span>
                        <button onclick="deleteCategory('${cat}')" class="ml-1 text-red-400 hover:text-red-600">×</button>
                    </div>`;
            });

            // Presupuestos
            const budList = document.getElementById('budget-config-list');
            budList.innerHTML = '';
            Object.keys(DB.categories).forEach(cat => {
                const val = DB.budgets[cat] || '';
                budList.innerHTML += `
                    <div class="flex items-center justify-between bg-gray-50 dark:bg-gray-700 p-2 rounded-lg">
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-8 rounded" style="background-color:${DB.categories[cat]}"></div>
                            <span class="text-sm dark:text-white">${cat}</span>
                        </div>
                        <input type="number" placeholder="Límite $" value="${val}" onchange="updateBudget('${cat}', this.value)"
                               class="w-24 p-1 text-right text-sm border border-gray-200 rounded outline-none dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                    </div>`;
            });
        }

        function updateBudget(cat, val) {
            const v = parseFloat(val);
            if(isNaN(v) || v <= 0) delete DB.budgets[cat];
            else DB.budgets[cat] = v;
            saveDB('budgets');
        }

        function addCategory() {
            const name = document.getElementById('new-cat-name').value.trim();
            const color = document.getElementById('new-cat-color').value;
            if(name && !DB.categories[name]) {
                DB.categories[name] = color;
                saveDB('categories');
                renderConfig();
                populateFilterCategory(); // Actualizar filtro
                document.getElementById('new-cat-name').value = '';
            } else alert('Nombre inválido o repetido');
        }

        function deleteCategory(name) {
            if(confirm('¿Borrar categoría '+name+'?')) {
                delete DB.categories[name];
                saveDB('categories');
                renderConfig();
                populateFilterCategory();
            }
        }

        // --- METAS Y DEUDAS (Simplificado) ---
        function renderGoalsView() {
            const dList = document.getElementById('debts-list');
            dList.innerHTML = '';
            if(DB.debts.length === 0) dList.innerHTML = '<p class="text-center text-xs text-gray-400">Sin deudas</p>';
            DB.debts.forEach((d, i) => {
                const rem = Math.max(d.total - d.paid, 0);
                const pct = Math.min((d.paid/d.total)*100, 100);
                dList.innerHTML += `
                    <div class="bg-red-50 dark:bg-red-900/10 p-3 rounded-lg border border-red-100 dark:border-red-900/30">
                        <div class="flex justify-between text-sm font-bold text-red-700 dark:text-red-300"><span>${d.name}</span><span>Resta: ${formatMoney(rem)}</span></div>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 h-2 rounded-full my-1"><div class="bg-red-500 h-2 rounded-full" style="width:${pct}%"></div></div>
                        <div class="flex justify-end gap-2 mt-2"><button onclick="payDebt(${i})" class="text-xs bg-white dark:bg-gray-800 border border-red-200 text-red-600 px-2 py-1 rounded">Abonar</button><button onclick="deleteDebt(${i})" class="text-xs text-gray-400">X</button></div>
                    </div>`;
            });

            const gList = document.getElementById('goals-list');
            gList.innerHTML = '';
            if(DB.goals.length === 0) gList.innerHTML = '<p class="text-center text-xs text-gray-400">Sin metas</p>';
            DB.goals.forEach((g, i) => {
                const pct = Math.min((g.saved/g.target)*100, 100);
                gList.innerHTML += `
                    <div class="bg-emerald-50 dark:bg-emerald-900/10 p-3 rounded-lg border border-emerald-100 dark:border-emerald-900/30">
                        <div class="flex justify-between text-sm font-bold text-emerald-700 dark:text-emerald-300"><span>${g.name}</span><span>${formatMoney(g.saved)} / ${formatMoney(g.target)}</span></div>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 h-2 rounded-full my-1"><div class="bg-emerald-500 h-2 rounded-full" style="width:${pct}%"></div></div>
                        <div class="flex justify-end gap-2 mt-2"><button onclick="addSavings(${i})" class="text-xs bg-white dark:bg-gray-800 border border-emerald-200 text-emerald-600 px-2 py-1 rounded">Ahorrar</button><button onclick="deleteGoal(${i})" class="text-xs text-gray-400">X</button></div>
                    </div>`;
            });
        }
        
        function openDebtModal() { document.getElementById('modal-debt').classList.remove('hidden'); document.getElementById('modal-debt').classList.add('flex'); }
        function saveDebt(e) { e.preventDefault(); DB.debts.push({name:document.getElementById('debt-name').value, total:parseFloat(document.getElementById('debt-total').value), paid:0}); saveDB('debts'); closeModal('modal-debt'); renderGoalsView(); }
        function payDebt(i) { const a=parseFloat(prompt('Monto abono:')); if(a){ DB.debts[i].paid+=a; saveDB('debts'); renderGoalsView(); } }
        function deleteDebt(i) { if(confirm('¿Borrar?')) { DB.debts.splice(i,1); saveDB('debts'); renderGoalsView(); } }

        function openGoalModal() { document.getElementById('modal-goal').classList.remove('hidden'); document.getElementById('modal-goal').classList.add('flex'); }
        function saveGoal(e) { e.preventDefault(); DB.goals.push({name:document.getElementById('goal-name').value, target:parseFloat(document.getElementById('goal-target').value), saved:parseFloat(document.getElementById('goal-current').value)||0}); saveDB('goals'); closeModal('modal-goal'); renderGoalsView(); }
        function addSavings(i) { const a=parseFloat(prompt('Monto ahorro:')); if(a){ DB.goals[i].saved+=a; saveDB('goals'); renderGoalsView(); } }
        function deleteGoal(i) { if(confirm('¿Borrar?')) { DB.goals.splice(i,1); saveDB('goals'); renderGoalsView(); } }

        // --- UTILIDADES ---
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); document.getElementById(id).classList.remove('flex'); }
        function openHelpModal() { document.getElementById('modal-help').classList.remove('hidden'); document.getElementById('modal-help').classList.add('flex'); }
        function formatMoney(n) { return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(n); }
        function setDefaultDates() {
            const today = new Date();
            const first = new Date(today.getFullYear(), 0, 1);
            document.getElementById('filter-date-start').valueAsDate = first;
            document.getElementById('filter-date-end').valueAsDate = today;
        }
        function toggleTheme() { document.documentElement.classList.toggle('dark'); localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light'; initTheme(); }
        function initTheme() { const isDark = localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches); if(isDark) document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark'); }
        function exportToExcel() {
            let csv = "\uFEFFFecha,Descripción,Categoría,Tipo,Monto\n";
            DB.transactions.forEach(t => csv += `${t.date},"${t.description}",${t.category},${t.type},${t.amount}\n`);
            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
            link.download = "finanzas.csv";
            link.click();
        }
        function downloadBackup() {
            const link = document.createElement("a");
            link.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(DB));
            link.download = `backup_finanzas_${new Date().toISOString().slice(0,10)}.json`;
            link.click();
        }
        function restoreData(input) {
            const f = input.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = e => {
                try {
                    const d = JSON.parse(e.target.result);
                    if(d.transactions && confirm('¿Restaurar respaldo completo?')) {
                        DB.transactions=d.transactions||[]; DB.categories=d.categories||defaultCats; DB.debts=d.debts||[]; DB.goals=d.goals||[]; DB.budgets=d.budgets||{};
                        saveDB('all'); location.reload();
                    } else if(Array.isArray(d) && confirm('¿Importar historial antiguo?')) {
                        DB.transactions=d; saveDB('transactions'); location.reload();
                    } else alert('Formato incorrecto');
                } catch(err) { alert('Error JSON'); }
                input.value='';
            };
            r.readAsText(f);
        }
        function wipeData() { if(confirm('¿BORRAR TODO?')) { localStorage.clear(); location.reload(); } }
    </script>
</body>
</html>
