<!DOCTYPE html>
<html lang="es">
    <!-- Configuraci√≥n PWA -->
<link rel="icon" type="image/png" href="icon.png">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0284c7">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon.png">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Comando Financiero</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- PWA Config -->
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0ea5e9">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: { 50:'#f0f9ff', 100:'#e0f2fe', 500:'#0ea5e9', 600:'#0284c7', 900:'#0c4a6e' }
                    }
                }
            }
        }
    </script>
    <style>
        body { transition: background-color 0.3s, color 0.3s; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* Animaciones */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .nav-active { color: #0ea5e9; font-weight: bold; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100 font-sans antialiased pb-24 h-screen flex flex-col overflow-hidden">

    <!-- INPUTS OCULTOS -->
    <input type="file" id="restore-input" accept=".json" class="hidden" onchange="restoreData(this)">

    <!-- ENCABEZADO SUPERIOR -->
    <header class="bg-white dark:bg-gray-800 shadow-sm shrink-0 z-20">
        <div class="max-w-5xl mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-lg font-bold text-brand-600 dark:text-brand-500 flex items-center gap-2">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i> <span id="header-title">Resumen</span>
            </h1>
            <div class="flex gap-2">
                <button onclick="toggleTheme()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-yellow-500 transition">
                    <i data-lucide="sun" id="theme-icon" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- CONTENEDOR PRINCIPAL (SCROLLABLE) -->
    <main id="main-container" class="flex-1 overflow-y-auto p-4 space-y-6 max-w-5xl mx-auto w-full no-scrollbar relative">
        
        <!-- VISTA 1: DASHBOARD (RESUMEN) -->
        <div id="view-dashboard" class="space-y-6 fade-in">
            <!-- Balance Cards -->
            <section class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="bg-gradient-to-br from-brand-500 to-brand-700 rounded-2xl p-5 text-white shadow-lg">
                    <p class="text-brand-100 text-xs font-medium uppercase tracking-wider">Disponible (Mes Actual)</p>
                    <h2 class="text-3xl font-bold mt-1" id="balance-amount">$0.00</h2>
                    <div class="flex justify-between mt-4 text-xs opacity-90">
                        <span><i data-lucide="arrow-up" class="inline w-3 h-3"></i> Ing: <span id="dash-income">$0</span></span>
                        <span><i data-lucide="arrow-down" class="inline w-3 h-3"></i> Gas: <span id="dash-expense">$0</span></span>
                    </div>
                </div>
                <!-- Gr√°fica R√°pida -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl p-4 shadow border border-gray-100 dark:border-gray-700 h-40 flex items-center justify-center relative">
                     <canvas id="miniChart"></canvas>
                     <div id="miniChart-empty" class="absolute text-xs text-gray-400 hidden">Sin datos este mes</div>
                </div>
            </section>

            <!-- Presupuestos (Barras de Progreso) -->
            <section class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-gray-700 dark:text-gray-200">Presupuestos (Alertas)</h3>
                    <button onclick="switchTab('config')" class="text-xs text-brand-500 hover:underline">Configurar</button>
                </div>
                <div id="budgets-container" class="space-y-3">
                    <!-- Se llena con JS -->
                    <p class="text-xs text-center text-gray-400 py-2">No has definido presupuestos a√∫n.</p>
                </div>
            </section>
        </div>

        <!-- VISTA 2: MOVIMIENTOS (HISTORIAL) -->
        <div id="view-transactions" class="hidden space-y-4 fade-in">
            <!-- Filtros -->
            <div class="flex gap-2 bg-white dark:bg-gray-800 p-2 rounded-lg shadow-sm overflow-x-auto no-scrollbar">
                <input type="date" id="filter-date-start" onchange="renderTransactions()" class="bg-gray-50 dark:bg-gray-700 border-none text-xs rounded p-2 outline-none">
                <input type="date" id="filter-date-end" onchange="renderTransactions()" class="bg-gray-50 dark:bg-gray-700 border-none text-xs rounded p-2 outline-none">
                <button onclick="exportToExcel()" class="bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 px-3 py-1 rounded text-xs whitespace-nowrap flex items-center gap-1">
                    <i data-lucide="sheet" class="w-3 h-3"></i> Excel
                </button>
            </div>

            <!-- Lista -->
            <div id="transactions-list" class="space-y-2 pb-20">
                <!-- Se llena con JS -->
            </div>
        </div>

        <!-- VISTA 3: METAS Y DEUDAS -->
        <div id="view-goals" class="hidden space-y-6 fade-in">
            <!-- Secci√≥n Deudas -->
            <section class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-red-100 dark:border-red-900/30">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-red-600 dark:text-red-400 flex items-center gap-2"><i data-lucide="credit-card" class="w-4 h-4"></i> Deudas</h3>
                    <button onclick="openDebtModal()" class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded hover:bg-red-200">+ Nueva</button>
                </div>
                <div id="debts-list" class="space-y-3">
                    <p class="text-xs text-center text-gray-400">¬°Libre de deudas! üéâ</p>
                </div>
            </section>

            <!-- Secci√≥n Metas de Ahorro -->
            <section class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-emerald-100 dark:border-emerald-900/30">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-emerald-600 dark:text-emerald-400 flex items-center gap-2"><i data-lucide="piggy-bank" class="w-4 h-4"></i> Metas</h3>
                    <button onclick="openGoalModal()" class="text-xs bg-emerald-100 text-emerald-600 px-2 py-1 rounded hover:bg-emerald-200">+ Nueva</button>
                </div>
                <div id="goals-list" class="space-y-3">
                    <p class="text-xs text-center text-gray-400">Define una meta para motivarte.</p>
                </div>
            </section>
        </div>

        <!-- VISTA 4: CONFIGURACI√ìN -->
        <div id="view-config" class="hidden space-y-4 fade-in">
            <!-- Categor√≠as -->
            <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm">
                <h3 class="font-bold mb-3 text-sm">Categor√≠as Personalizadas (Gastos)</h3>
                <div class="flex gap-2 mb-3">
                    <input type="text" id="new-cat-name" placeholder="Nueva categor√≠a..." class="flex-1 bg-gray-50 dark:bg-gray-700 p-2 rounded text-sm outline-none border border-gray-200 dark:border-gray-600">
                    <input type="color" id="new-cat-color" value="#3b82f6" class="h-9 w-9 rounded cursor-pointer border-none bg-transparent">
                    <button onclick="addCategory()" class="bg-brand-600 text-white p-2 rounded"><i data-lucide="plus" class="w-4 h-4"></i></button>
                </div>
                <div id="config-categories-list" class="flex flex-wrap gap-2">
                    <!-- Chips de categor√≠as -->
                </div>
            </div>

            <!-- Gesti√≥n de Datos -->
            <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm">
                <h3 class="font-bold mb-3 text-sm">Datos y Respaldo</h3>
                <div class="p-3 mb-3 bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300 text-xs rounded-lg">
                    <i data-lucide="info" class="inline w-3 h-3 mr-1"></i>
                    El respaldo ahora guarda Metas, Deudas y Categor√≠as.
                </div>
                <div class="space-y-2">
                    <button onclick="downloadBackup()" class="w-full flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg text-sm transition hover:bg-gray-100">
                        <span><i data-lucide="download" class="inline w-4 h-4 mr-2"></i> Descargar Respaldo Completo</span>
                    </button>
                    <button onclick="document.getElementById('restore-input').click()" class="w-full flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg text-sm transition hover:bg-gray-100">
                        <span><i data-lucide="upload" class="inline w-4 h-4 mr-2"></i> Restaurar Respaldo</span>
                    </button>
                    <button onclick="wipeData()" class="w-full flex items-center justify-between p-3 bg-red-50 dark:bg-red-900/20 text-red-600 rounded-lg text-sm border border-red-100 dark:border-red-900/30 transition hover:bg-red-100">
                        <span><i data-lucide="trash" class="inline w-4 h-4 mr-2"></i> Borrar Todo (Reset)</span>
                    </button>
                </div>
            </div>
        </div>

    </main>

    <!-- BARRA DE NAVEGACI√ìN INFERIOR -->
    <nav class="fixed bottom-0 w-full bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 pb-safe z-30 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
        <div class="max-w-5xl mx-auto flex justify-around items-center h-16">
            <button onclick="switchTab('dashboard')" class="nav-btn flex flex-col items-center gap-1 text-gray-400 w-full" id="nav-dashboard">
                <i data-lucide="home" class="w-5 h-5"></i>
                <span class="text-[10px]">Inicio</span>
            </button>
            <button onclick="switchTab('transactions')" class="nav-btn flex flex-col items-center gap-1 text-gray-400 w-full" id="nav-transactions">
                <i data-lucide="list" class="w-5 h-5"></i>
                <span class="text-[10px]">Historial</span>
            </button>
            
            <!-- Bot√≥n Central Flotante (Agregar) -->
            <div class="relative -top-5">
                <button onclick="openTransactionModal()" class="bg-brand-600 hover:bg-brand-700 text-white w-14 h-14 rounded-full shadow-xl flex items-center justify-center transition-transform hover:scale-110 active:scale-95 ring-4 ring-white dark:ring-gray-900">
                    <i data-lucide="plus" class="w-7 h-7"></i>
                </button>
            </div>

            <button onclick="switchTab('goals')" class="nav-btn flex flex-col items-center gap-1 text-gray-400 w-full" id="nav-goals">
                <i data-lucide="target" class="w-5 h-5"></i>
                <span class="text-[10px]">Metas</span>
            </button>
            <button onclick="switchTab('config')" class="nav-btn flex flex-col items-center gap-1 text-gray-400 w-full" id="nav-config">
                <i data-lucide="settings" class="w-5 h-5"></i>
                <span class="text-[10px]">Config</span>
            </button>
        </div>
    </nav>

    <!-- MODALES -->
    
    <!-- Modal Transacci√≥n -->
    <div id="modal-transaction" class="fixed inset-0 bg-black/60 hidden items-end sm:items-center justify-center z-50 p-0 sm:p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white dark:bg-gray-800 rounded-t-2xl sm:rounded-2xl w-full max-w-md shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center">
                <h3 class="font-bold dark:text-white">Nuevo Movimiento</h3>
                <button onclick="closeModal('modal-transaction')" class="p-1 text-gray-400"><i data-lucide="x"></i></button>
            </div>
            <form onsubmit="saveTransaction(event)" class="p-4 space-y-4 overflow-y-auto">
                <input type="hidden" id="tx-id">
                <!-- Toggle Gasto/Ingreso -->
                <div class="flex bg-gray-100 dark:bg-gray-700 p-1 rounded-lg">
                    <button type="button" id="btn-type-expense" onclick="setTxType('expense')" class="flex-1 py-2 text-sm font-bold rounded shadow bg-white text-red-500">Gasto</button>
                    <button type="button" id="btn-type-income" onclick="setTxType('income')" class="flex-1 py-2 text-sm text-gray-500">Ingreso</button>
                </div>
                <input type="hidden" id="tx-type" value="expense">

                <input type="number" id="tx-amount" step="any" required placeholder="$0.00" class="w-full text-3xl font-bold text-center bg-transparent border-b border-gray-200 dark:border-gray-700 outline-none p-2 dark:text-white">

                <div class="grid grid-cols-2 gap-3">
                    <input type="date" id="tx-date" required class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg text-sm dark:text-white outline-none">
                    <select id="tx-category" class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg text-sm dark:text-white outline-none">
                        <!-- Llenado din√°mico -->
                    </select>
                </div>

                <input type="text" id="tx-desc" required placeholder="Descripci√≥n (ej. Tacos)" class="w-full bg-gray-50 dark:bg-gray-700 p-3 rounded-lg text-sm dark:text-white outline-none">

                <div id="viaticos-check" class="flex items-center gap-2 p-3 bg-orange-50 dark:bg-orange-900/20 rounded-lg text-sm">
                    <input type="checkbox" id="tx-viatico" class="w-4 h-4">
                    <label for="tx-viatico" class="text-orange-700 dark:text-orange-300">Es vi√°tico / viaje</label>
                </div>

                <div id="budget-set-container" class="hidden">
                    <label class="text-xs text-gray-500 block mb-1">Presupuesto Mensual para esta categor√≠a:</label>
                    <input type="number" id="cat-budget-input" placeholder="Opcional: L√≠mite mensual" class="w-full bg-gray-50 dark:bg-gray-700 p-2 rounded text-xs dark:text-white">
                </div>

                <button type="submit" class="w-full bg-brand-600 text-white py-3 rounded-lg font-bold shadow-lg hover:bg-brand-700">Guardar</button>
            </form>
        </div>
    </div>

    <!-- Modal Deuda -->
    <div id="modal-debt" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-sm p-5 shadow-2xl">
            <h3 class="font-bold mb-4 dark:text-white">Registrar Deuda</h3>
            <form onsubmit="saveDebt(event)" class="space-y-3">
                <input type="text" id="debt-name" required placeholder="Nombre (ej. Tarjeta Oro)" class="w-full p-2 border rounded dark:bg-gray-700 dark:text-white">
                <input type="number" id="debt-total" required placeholder="Monto Total a Deber" step="any" class="w-full p-2 border rounded dark:bg-gray-700 dark:text-white">
                <div class="flex gap-2 pt-2">
                    <button type="button" onclick="closeModal('modal-debt')" class="flex-1 bg-gray-200 dark:bg-gray-700 py-2 rounded">Cancelar</button>
                    <button type="submit" class="flex-1 bg-red-500 text-white py-2 rounded">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Meta -->
    <div id="modal-goal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-sm p-5 shadow-2xl">
            <h3 class="font-bold mb-4 dark:text-white">Nueva Meta de Ahorro</h3>
            <form onsubmit="saveGoal(event)" class="space-y-3">
                <input type="text" id="goal-name" required placeholder="Meta (ej. Viaje Canc√∫n)" class="w-full p-2 border rounded dark:bg-gray-700 dark:text-white">
                <input type="number" id="goal-target" required placeholder="Monto Objetivo" step="any" class="w-full p-2 border rounded dark:bg-gray-700 dark:text-white">
                <input type="number" id="goal-current" placeholder="Ahorro Inicial (Opcional)" step="any" class="w-full p-2 border rounded dark:bg-gray-700 dark:text-white">
                <div class="flex gap-2 pt-2">
                    <button type="button" onclick="closeModal('modal-goal')" class="flex-1 bg-gray-200 dark:bg-gray-700 py-2 rounded">Cancelar</button>
                    <button type="submit" class="flex-1 bg-emerald-500 text-white py-2 rounded">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- BASE DE DATOS LOCAL ---
        const DB = {
            transactions: JSON.parse(localStorage.getItem('myExpenses')) || [], 
            categories: JSON.parse(localStorage.getItem('myCategories')) || {},
            debts: JSON.parse(localStorage.getItem('myDebts')) || [],
            goals: JSON.parse(localStorage.getItem('myGoals')) || [],
            budgets: JSON.parse(localStorage.getItem('myBudgets')) || {}
        };

        const defaultCats = {
            'Alimentos': '#F87171', 'Transporte': '#60A5FA', 'Vivienda': '#34D399',
            'Servicios': '#FBBF24', 'Salud': '#F472B6', 'Entretenimiento': '#A78BFA', 
            'Otros': '#CBD5E1'
        };

        // CORRECCI√ìN: Categor√≠as Exclusivas de Ingreso
        const incomeCats = {
            'N√≥mina': '#10B981', 'Ventas': '#34D399', 'Reembolso': '#6EE7B7',
            'Regalo': '#A7F3D0', 'Inversi√≥n': '#059669', 'Otros Ingresos': '#D1FAE5'
        };

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            initTheme();
            initData();
            setDefaultDates();
            switchTab('dashboard'); 
        });

        function initData() {
            // Migraci√≥n de datos viejos (si existen)
            if(Array.isArray(DB.transactions)) {
                DB.transactions = DB.transactions.map(t => ({...t, type: t.type || 'expense'}));
            }
            
            // Cargar categor√≠as default si est√° vac√≠o
            if (Object.keys(DB.categories).length === 0) {
                DB.categories = {...defaultCats};
                saveDB('categories');
            }
        }

        function saveDB(key) {
            if(key === 'all') {
                localStorage.setItem('myExpenses', JSON.stringify(DB.transactions));
                localStorage.setItem('myCategories', JSON.stringify(DB.categories));
                localStorage.setItem('myDebts', JSON.stringify(DB.debts));
                localStorage.setItem('myGoals', JSON.stringify(DB.goals));
                localStorage.setItem('myBudgets', JSON.stringify(DB.budgets));
            } else {
                let storeKey = 'myExpenses'; 
                if(key === 'categories') storeKey = 'myCategories';
                if(key === 'debts') storeKey = 'myDebts';
                if(key === 'goals') storeKey = 'myGoals';
                if(key === 'budgets') storeKey = 'myBudgets';
                localStorage.setItem(storeKey, JSON.stringify(DB[key]));
            }
        }

        // --- NAVEGACI√ìN ---
        function switchTab(tabId) {
            ['dashboard', 'transactions', 'goals', 'config'].forEach(id => {
                document.getElementById('view-' + id).classList.add('hidden');
                const btn = document.getElementById('nav-' + id);
                if(btn) {
                    btn.classList.remove('nav-active');
                    btn.classList.add('text-gray-400');
                }
            });

            document.getElementById('view-' + tabId).classList.remove('hidden');
            const activeBtn = document.getElementById('nav-' + tabId);
            if(activeBtn) {
                activeBtn.classList.add('nav-active');
                activeBtn.classList.remove('text-gray-400');
            }

            const titles = { 'dashboard': 'Resumen', 'transactions': 'Historial', 'goals': 'Metas y Deudas', 'config': 'Configuraci√≥n' };
            document.getElementById('header-title').innerText = titles[tabId];

            if(tabId === 'dashboard') renderDashboard();
            if(tabId === 'transactions') renderTransactions();
            if(tabId === 'goals') renderGoalsView();
            if(tabId === 'config') renderConfig();
        }

        // --- DASHBOARD ---
        let miniChart = null;
        function renderDashboard() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);

            const currentMonthTx = DB.transactions.filter(t => {
                const d = new Date(t.date);
                return d >= firstDay && d <= lastDay;
            });

            const income = currentMonthTx.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
            const expense = currentMonthTx.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
            const balance = income - expense;

            document.getElementById('balance-amount').innerText = formatMoney(balance);
            document.getElementById('dash-income').innerText = formatMoney(income);
            document.getElementById('dash-expense').innerText = formatMoney(expense);

            updateMiniChart(currentMonthTx);
            renderBudgets(currentMonthTx);
        }

        function updateMiniChart(txs) {
            const ctx = document.getElementById('miniChart');
            const expenses = txs.filter(t => t.type === 'expense');
            
            if(expenses.length === 0) {
                document.getElementById('miniChart-empty').classList.remove('hidden');
                ctx.style.opacity = 0;
                return;
            } else {
                document.getElementById('miniChart-empty').classList.add('hidden');
                ctx.style.opacity = 1;
            }

            const dataMap = {};
            expenses.forEach(t => { dataMap[t.category] = (dataMap[t.category] || 0) + t.amount });
            
            if(miniChart) miniChart.destroy();
            miniChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(dataMap),
                    datasets: [{
                        data: Object.values(dataMap),
                        backgroundColor: Object.keys(dataMap).map(c => DB.categories[c] || '#ccc'),
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        function renderBudgets(monthTxs) {
            const container = document.getElementById('budgets-container');
            container.innerHTML = '';
            
            const catsWithBudget = Object.keys(DB.budgets);
            if(catsWithBudget.length === 0) {
                container.innerHTML = `<p class="text-xs text-center text-gray-400 py-2">Ve a Configuraci√≥n para definir l√≠mites.</p>`;
                return;
            }

            const spentMap = {};
            monthTxs.filter(t => t.type === 'expense').forEach(t => spentMap[t.category] = (spentMap[t.category] || 0) + t.amount);

            catsWithBudget.forEach(cat => {
                const limit = DB.budgets[cat];
                const spent = spentMap[cat] || 0;
                const percent = Math.min((spent / limit) * 100, 100);
                
                let barColor = 'bg-emerald-500';
                if(percent > 75) barColor = 'bg-yellow-500';
                if(percent >= 100) barColor = 'bg-red-500';

                const div = document.createElement('div');
                div.className = "text-sm";
                div.innerHTML = `
                    <div class="flex justify-between mb-1">
                        <span class="font-medium dark:text-gray-200">${cat}</span>
                        <span class="text-xs text-gray-500">${formatMoney(spent)} / ${formatMoney(limit)}</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                        <div class="${barColor} h-2.5 rounded-full" style="width: ${percent}%"></div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // --- MOVIMIENTOS ---
        function renderTransactions() {
            const start = document.getElementById('filter-date-start').value;
            const end = document.getElementById('filter-date-end').value;
            const list = document.getElementById('transactions-list');
            list.innerHTML = '';

            const filtered = DB.transactions.filter(t => t.date >= start && t.date <= end)
                                           .sort((a, b) => new Date(b.date) - new Date(a.date));

            if(filtered.length === 0) {
                list.innerHTML = `<div class="text-center text-gray-400 py-10">Sin movimientos</div>`;
                return;
            }

            filtered.forEach(t => {
                const isExp = t.type === 'expense';
                const color = isExp ? 'text-gray-800 dark:text-gray-100' : 'text-emerald-600 font-bold';
                const sign = isExp ? '-' : '+';
                // CORRECCI√ìN: Buscar color en ambas listas
                const catColor = DB.categories[t.category] || incomeCats[t.category] || '#999';

                const div = document.createElement('div');
                div.className = "flex justify-between items-center bg-white dark:bg-gray-800 p-3 rounded-lg shadow-sm border-b border-gray-50 dark:border-gray-700";
                div.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-[10px] font-bold shrink-0" style="background-color:${catColor}">
                            ${t.category.substring(0,2).toUpperCase()}
                        </div>
                        <div class="min-w-0">
                            <p class="font-medium truncate text-sm dark:text-gray-200">${t.description}</p>
                            <p class="text-xs text-gray-400">${t.date} ‚Ä¢ ${t.category}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="${color} text-sm">${sign}${formatMoney(t.amount)}</p>
                        <button onclick="deleteTransaction('${t.id}')" class="text-xs text-red-400 opacity-50 hover:opacity-100">Borrar</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        // --- METAS Y DEUDAS ---
        function renderGoalsView() {
            const debtsList = document.getElementById('debts-list');
            debtsList.innerHTML = '';
            if(DB.debts.length === 0) debtsList.innerHTML = `<p class="text-xs text-center text-gray-400">Sin deudas registradas.</p>`;
            
            DB.debts.forEach((d, idx) => {
                const percent = Math.min(((d.paid / d.total) * 100), 100) || 0;
                const remaining = Math.max(d.total - (d.paid || 0), 0);
                
                const el = document.createElement('div');
                el.className = "bg-red-50 dark:bg-red-900/10 p-3 rounded-lg border border-red-100 dark:border-red-900/30";
                el.innerHTML = `
                    <div class="flex justify-between text-sm font-bold text-red-700 dark:text-red-300 mb-1">
                        <span>${d.name}</span>
                        <span>Restan: ${formatMoney(remaining)}</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mb-2">
                        <div class="bg-red-500 h-2 rounded-full" style="width: ${percent}%"></div>
                    </div>
                    <div class="flex justify-end gap-2">
                         <button onclick="payDebt(${idx})" class="text-xs bg-white dark:bg-gray-800 border border-red-200 text-red-600 px-2 py-1 rounded">Abonar</button>
                         <button onclick="deleteDebt(${idx})" class="text-xs text-gray-400 px-2">X</button>
                    </div>
                `;
                debtsList.appendChild(el);
            });

            const goalsList = document.getElementById('goals-list');
            goalsList.innerHTML = '';
            if(DB.goals.length === 0) goalsList.innerHTML = `<p class="text-xs text-center text-gray-400">Sin metas activas.</p>`;

            DB.goals.forEach((g, idx) => {
                const percent = Math.min(((g.saved / g.target) * 100), 100) || 0;
                const el = document.createElement('div');
                el.className = "bg-emerald-50 dark:bg-emerald-900/10 p-3 rounded-lg border border-emerald-100 dark:border-emerald-900/30";
                el.innerHTML = `
                    <div class="flex justify-between text-sm font-bold text-emerald-700 dark:text-emerald-300 mb-1">
                        <span>${g.name}</span>
                        <span>${formatMoney(g.saved)} / ${formatMoney(g.target)}</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mb-2">
                        <div class="bg-emerald-500 h-2 rounded-full" style="width: ${percent}%"></div>
                    </div>
                    <div class="flex justify-end gap-2">
                         <button onclick="addSavings(${idx})" class="text-xs bg-white dark:bg-gray-800 border border-emerald-200 text-emerald-600 px-2 py-1 rounded">Ahorrar</button>
                         <button onclick="deleteGoal(${idx})" class="text-xs text-gray-400 px-2">X</button>
                    </div>
                `;
                goalsList.appendChild(el);
            });
        }

        // --- CONFIGURACI√ìN Y CATEGOR√çAS ---
        function renderConfig() {
            const list = document.getElementById('config-categories-list');
            list.innerHTML = '';
            
            Object.keys(DB.categories).forEach(cat => {
                const color = DB.categories[cat];
                const tag = document.createElement('div');
                tag.className = "flex items-center gap-1 bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded text-xs border border-gray-200 dark:border-gray-600";
                tag.innerHTML = `
                    <div class="w-3 h-3 rounded-full" style="background-color:${color}"></div>
                    <span class="dark:text-white">${cat}</span>
                    <button onclick="deleteCategory('${cat}')" class="ml-1 text-red-400 hover:text-red-600">√ó</button>
                `;
                list.appendChild(tag);
            });
        }

        function addCategory() {
            const name = document.getElementById('new-cat-name').value.trim();
            const color = document.getElementById('new-cat-color').value;
            if(name && !DB.categories[name]) {
                DB.categories[name] = color;
                saveDB('categories');
                renderConfig();
                document.getElementById('new-cat-name').value = '';
            } else {
                alert('Nombre inv√°lido o ya existe');
            }
        }

        function deleteCategory(name) {
            if(confirm('¬øBorrar categor√≠a ' + name + '?')) {
                delete DB.categories[name];
                saveDB('categories');
                renderConfig();
            }
        }

        // --- GESTI√ìN DE MODALES Y FORMULARIOS ---

        function openTransactionModal() {
            document.getElementById('modal-transaction').classList.remove('hidden');
            document.getElementById('modal-transaction').classList.add('flex');
            document.getElementById('tx-date').valueAsDate = new Date();
            
            // Iniciar por defecto como Gasto y rellenar categor√≠as
            document.getElementById('tx-amount').value = '';
            document.getElementById('tx-desc').value = '';
            setTxType('expense'); // Esto dispara la carga de categor√≠as
            checkBudgetSetting();
        }

        function checkBudgetSetting() {
            const type = document.getElementById('tx-type').value;
            const cat = document.getElementById('tx-category').value;
            const container = document.getElementById('budget-set-container');
            const input = document.getElementById('cat-budget-input');

            if(type === 'expense') {
                container.classList.remove('hidden');
                input.value = DB.budgets[cat] || '';
            } else {
                container.classList.add('hidden');
            }
        }
        document.getElementById('tx-category').addEventListener('change', checkBudgetSetting);

        // NUEVA FUNCI√ìN: Rellenar select din√°micamente
        function populateCategorySelect(type) {
            const select = document.getElementById('tx-category');
            select.innerHTML = '';
            
            // Si es gasto usa DB.categories (customizables), si es ingreso usa incomeCats (fijas)
            const source = (type === 'expense') ? DB.categories : incomeCats;
            
            Object.keys(source).forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.innerText = c;
                select.appendChild(opt);
            });
        }

        function setTxType(type) {
            document.getElementById('tx-type').value = type;
            const btnExp = document.getElementById('btn-type-expense');
            const btnInc = document.getElementById('btn-type-income');
            const viatico = document.getElementById('viaticos-check');

            if(type === 'expense') {
                btnExp.className = "flex-1 py-2 text-sm font-bold rounded shadow bg-white text-red-500 transition-all";
                btnInc.className = "flex-1 py-2 text-sm text-gray-500 hover:bg-gray-200 transition-all";
                viatico.classList.remove('hidden');
            } else {
                btnInc.className = "flex-1 py-2 text-sm font-bold rounded shadow bg-white text-emerald-500 transition-all";
                btnExp.className = "flex-1 py-2 text-sm text-gray-500 hover:bg-gray-200 transition-all";
                viatico.classList.add('hidden');
            }
            
            // Llamar al rellenado
            populateCategorySelect(type);
            checkBudgetSetting();
        }

        function saveTransaction(e) {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('tx-amount').value);
            const desc = document.getElementById('tx-desc').value;
            const date = document.getElementById('tx-date').value;
            const category = document.getElementById('tx-category').value;
            const type = document.getElementById('tx-type').value;
            const isViatico = document.getElementById('tx-viatico').checked;
            
            if(type === 'expense') {
                const budgetVal = parseFloat(document.getElementById('cat-budget-input').value);
                if(!isNaN(budgetVal) && budgetVal > 0) {
                    DB.budgets[category] = budgetVal;
                    saveDB('budgets');
                }
            }

            const newTx = {
                id: Date.now().toString(),
                amount: Math.abs(amount),
                description: desc,
                date: date,
                category: category,
                type: type,
                isViaticos: (type === 'expense' && isViatico)
            };

            DB.transactions.push(newTx);
            saveDB('transactions');
            
            // Auto ajustar filtros (UX Fix)
            const start = document.getElementById('filter-date-start');
            const end = document.getElementById('filter-date-end');
            if(date < start.value) start.value = date;
            if(date > end.value) end.value = date;

            closeModal('modal-transaction');
            
            const currentTab = document.querySelector('.nav-active').id.replace('nav-', '');
            if(currentTab === 'dashboard') renderDashboard();
            if(currentTab === 'transactions') renderTransactions();
        }

        function deleteTransaction(id) {
            if(confirm('¬øEliminar registro?')) {
                DB.transactions = DB.transactions.filter(t => t.id !== id);
                saveDB('transactions');
                renderTransactions();
            }
        }

        // --- LOGICA DEUDAS ---
        function openDebtModal() {
            document.getElementById('modal-debt').classList.remove('hidden');
            document.getElementById('modal-debt').classList.add('flex');
        }
        function saveDebt(e) {
            e.preventDefault();
            const name = document.getElementById('debt-name').value;
            const total = parseFloat(document.getElementById('debt-total').value);
            DB.debts.push({ name, total, paid: 0 });
            saveDB('debts');
            closeModal('modal-debt');
            renderGoalsView();
        }
        function payDebt(idx) {
            const amount = parseFloat(prompt("¬øCu√°nto vas a abonar?"));
            if(amount) {
                const debt = DB.debts[idx];
                const remaining = debt.total - (debt.paid || 0);
                
                // Logic check: No abonar m√°s de la deuda
                if(amount > remaining) {
                    alert(`¬°Error! Solo debes ${formatMoney(remaining)}.`);
                    return;
                }

                DB.debts[idx].paid = (DB.debts[idx].paid || 0) + amount;
                
                if(confirm("¬øRegistrar esto como Gasto en el historial?")) {
                     DB.transactions.push({
                         id: Date.now().toString(),
                         amount: amount,
                         description: 'Abono: ' + DB.debts[idx].name,
                         date: new Date().toISOString().split('T')[0],
                         category: 'Deudas',
                         type: 'expense',
                         isViaticos: false
                     });
                     saveDB('transactions');
                }
                saveDB('debts');
                renderGoalsView();
            }
        }
        function deleteDebt(idx) {
            if(confirm('¬øBorrar esta deuda del registro?')) {
                DB.debts.splice(idx, 1);
                saveDB('debts');
                renderGoalsView();
            }
        }

        // --- LOGICA METAS ---
        function openGoalModal() {
            document.getElementById('modal-goal').classList.remove('hidden');
            document.getElementById('modal-goal').classList.add('flex');
        }
        function saveGoal(e) {
            e.preventDefault();
            const name = document.getElementById('goal-name').value;
            const target = parseFloat(document.getElementById('goal-target').value);
            const current = parseFloat(document.getElementById('goal-current').value) || 0;
            DB.goals.push({ name, target, saved: current });
            saveDB('goals');
            closeModal('modal-goal');
            renderGoalsView();
        }
        function addSavings(idx) {
            const amount = parseFloat(prompt("¬øCu√°nto vas a ahorrar hoy?"));
            if(amount) {
                DB.goals[idx].saved += amount;
                
                if(confirm("¬øRegistrar como movimiento de 'Ahorro' (Gasto)?")) {
                    DB.transactions.push({
                         id: Date.now().toString(),
                         amount: amount,
                         description: 'Ahorro: ' + DB.goals[idx].name,
                         date: new Date().toISOString().split('T')[0],
                         category: 'Ahorro',
                         type: 'expense',
                         isViaticos: false
                     });
                     saveDB('transactions');
                }
                saveDB('goals');
                renderGoalsView();
            }
        }
        function deleteGoal(idx) {
            if(confirm('¬øBorrar meta?')) {
                DB.goals.splice(idx, 1);
                saveDB('goals');
                renderGoalsView();
            }
        }

        // --- EXPORTAR EXCEL (CSV) ---
        function exportToExcel() {
            // Fix: BOM para Excel
            let csvContent = "\uFEFF"; 
            csvContent += "Fecha,Descripcion,Categoria,Tipo,Monto,Es Viatico\n";

            DB.transactions.forEach(t => {
                const row = `${t.date},"${t.description}",${t.category},${t.type},${t.amount},${t.isViaticos ? 'SI' : 'NO'}`;
                csvContent += row + "\n";
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "mis_movimientos.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- UTILIDADES ---
        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
            document.getElementById(id).classList.remove('flex');
        }
        function formatMoney(n) { 
            // Fix decimales feos
            return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(n); 
        }
        function setDefaultDates() {
            const today = new Date();
            const first = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('filter-date-start').valueAsDate = first;
            document.getElementById('filter-date-end').valueAsDate = today;
        }

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            initTheme();
        }
        function initTheme() {
            const isDark = localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
            if(isDark) document.documentElement.classList.add('dark');
            else document.documentElement.classList.remove('dark');
        }

        // --- RESPALDO FULL ---
        function downloadBackup() {
            // Fix: Respaldo Completo (DB entero)
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(DB));
            const node = document.createElement('a');
            node.setAttribute("href", dataStr);
            const date = new Date().toISOString().slice(0,10);
            node.setAttribute("download", `backup_finanzas_full_${date}.json`);
            document.body.appendChild(node);
            node.click(); node.remove();
        }
        
        function restoreData(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Soporte Legacy (Array) vs Nuevo (Objeto Completo)
                    if(Array.isArray(data)) {
                        if(confirm('‚ö†Ô∏è ESTE ES UN RESPALDO ANTIGUO. Solo contiene transacciones. ¬øDeseas importarlas? (Tus metas/deudas actuales se mantendr√°n)')) {
                            DB.transactions = data;
                            saveDB('transactions');
                            location.reload();
                        }
                    } else if (data.transactions) {
                         if(confirm('‚ö†Ô∏è RESTAURAR COMPLETO: Esto reemplazar√° TODAS tus transacciones, metas, deudas y configuraciones actuales con las del archivo. ¬øContinuar?')) {
                            // Cargar todo
                            DB.transactions = data.transactions || [];
                            DB.categories = data.categories || defaultCats;
                            DB.debts = data.debts || [];
                            DB.goals = data.goals || [];
                            DB.budgets = data.budgets || {};
                            saveDB('all');
                            location.reload();
                         }
                    } else {
                        alert("Formato de archivo no reconocido.");
                    }

                } catch(err) { 
                    console.error(err);
                    alert('Error al leer el archivo JSON.'); 
                }
                input.value = ''; // Reset input
            };
            reader.readAsText(file);
        }

        function wipeData() {
            if(confirm('‚ö†Ô∏è ¬øBORRAR TODO? Esta acci√≥n es irreversible.')) {
                localStorage.clear();
                location.reload();
            }
        }
    </script>
</body>
</html>
